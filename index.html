export default async function handler(req, res) {
  console.log('收到请求，方法:', req.method);
  console.log('请求体大小:', JSON.stringify(req.body).length);
  console.log('请求体字段:', Object.keys(req.body));

  if (req.method !== 'POST') {
    return res.status(405).json({ error: '只支持 POST 请求' });
  }

  const { htmlContent, productLink, isHtmlMode, links } = req.body;

  console.log('isHtmlMode:', isHtmlMode);
  console.log('htmlContent 长度:', htmlContent ? htmlContent.length : 'null');
  console.log('productLink:', productLink);

  // 检查是否是 HTML 模式
  if (isHtmlMode && htmlContent) {
    console.log('进入 HTML 模式');

    if (!htmlContent || typeof htmlContent !== 'string' || htmlContent.length < 100) {
      console.log('HTML 内容验证失败');
      return res.status(400).json({ error: 'HTML 内容无效或过短' });
    }

    const htmlTruncated = htmlContent.substring(0, 50000);

    const analysisContent = `用户已下载页面的完整 HTML 源代码。请从下面的页面源代码中准确提取产品数据：

**页面链接**: ${productLink || '未提供'}

**页面源代码**:
\`\`\`html
${htmlTruncated}
\`\`\`

**重要提示**: 所有数据必须来自上面的页面源代码中明确显示的内容。
- 页面显示"20,000Pa"就提取"20,000Pa"，不能改
- 页面显示"322"就是 322，不能改
- 无法找到的数据标注"[页面未标注]"`;

    try {
      console.log('正在调用阿里云百炼 API...');

      const response = await fetch(
        'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
        {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'qwen-plus',
            input: {
              messages: [
                {
                  role: 'system',
                  content: `你是专业的电商数据分析师。请从提供的产品信息中准确提取以下数据：

1. 产品名称和具体类别
2. 规格参数（8-10 个关键参数）
3. 评价统计（总数、各等级数量和百分比）
4. 用户评论摘要（正面 3 个词、负面 3 个词）
5. 产品卖点（5 个主要卖点）

**严格规则**:
- 页面显示的数字必须准确复制，不能修改
- 无法找到的数据必须标注"[页面未标注]"
- 评价百分比必须加和 = 100%
- 返回必须是有效 JSON

**返回格式**:
{
  "products": [
    {
      "name": "产品名称",
      "category": "类别",
      "sellingPoints": ["卖点1", "卖点2", "卖点3", "卖点4", "卖点5"],
      "reviews": {
        "totalCount": 评价总数,
        "distribution": {
          "5star": { "count": 数字, "percentage": "百分比" },
          "4star": { "count": 数字, "percentage": "百分比" },
          "3star": { "count": 数字, "percentage": "百分比" },
          "2star": { "count": 数字, "percentage": "百分比" },
          "1star": { "count": 数字, "percentage": "百分比" }
        },
        "likes": ["词1", "词2", "词3"],
        "dislikes": ["词1", "词2", "词3"]
      },
      "parameters": {
        "参数1": "值",
        "参数2": "值",
        "参数3": "值",
        "参数4": "值",
        "参数5": "值",
        "参数6": "值",
        "参数7": "值",
        "参数8": "值"
      }
    }
  ],
  "comparisonInsights": {
    "优势对比": "分析",
    "劣势提醒": "分析",
    "适用场景": "分析",
    "采购建议": "分析"
  },
  "suggestions": "综合建议"
}`
                },
                {
                  role: 'user',
                  content: analysisContent
                }
              ]
            },
            parameters: {
              temperature: 0.3,
              max_tokens: 3000,
              top_p: 0.8,
              repetition_penalty: 1.0
            }
          })
        }
      );

      console.log('API 响应状态:', response.status);

      if (!response.ok) {
        const errorData = await response.json();
        console.error('API 错误:', errorData);
        return res.status(response.status).json({
          error: `API 调用失败: ${errorData.message || '未知错误'}`
        });
      }

      const data = await response.json();
      console.log('API 返回数据');

      let content = data.output?.text || data.output?.content || data.choices?.[0]?.message?.content;

      if (!content) {
        console.error('无法从 API 响应中提取内容');
        return res.status(500).json({ error: '未获得有效的 AI 响应内容' });
      }

      let parsed;
      try {
        parsed = JSON.parse(content);
        console.log('JSON 解析成功');
      } catch (e) {
        console.warn('直接 JSON 解析失败，尝试提取...');
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          parsed = JSON.parse(jsonMatch[0]);
          console.log('JSON 提取成功');
        } else {
          console.error('JSON 提取失败:', content.substring(0, 200));
          return res.status(500).json({ error: '无法解析 AI 返回的 JSON 格式' });
        }
      }

      if (!parsed.products || !Array.isArray(parsed.products)) {
        parsed.products = parsed.products || [];
      }

      console.log('分析完成，返回结果');
      return res.status(200).json(parsed);

    } catch (error) {
      console.error('服务器错误:', error.message);
      return res.status(500).json({
        error: `服务器错误: ${error.message}`
      });
    }
  } else {
    // 既不是 HTML 模式也没有提供链接
    console.log('ERROR: 未检测到 HTML 模式且未提供链接');
    console.log('isHtmlMode:', isHtmlMode, '| htmlContent:', htmlContent ? '有' : '无', '| links:', links);
    return res.status(400).json({ 
      error: '请上传页面 HTML 文件',
      debug: {
        isHtmlMode,
        hasHtmlContent: !!htmlContent,
        hasLinks: !!links
      }
    });
  }
}
